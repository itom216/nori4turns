import streamlit as st
from openai import OpenAI

# =========================
# ç”»é¢è¨­å®š
# =========================
st.set_page_config(page_title="ã®ã‚Š LINEé¢¨", layout="centered")

st.title("ğŸ¥ ã®ã‚Šï¼ˆLINEé¢¨ï¼‰")
st.caption("ä¸‹ã«å…¥åŠ›æ¬„ãŒã‚ã‚‹ã§")

# =========================
# APIã‚­ãƒ¼å…¥åŠ›ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
# =========================
api_key = st.text_input("ğŸ”‘ OpenAI APIã‚­ãƒ¼", type="password")
if not api_key:
    st.stop()

client = OpenAI(api_key=api_key)

# =========================
# å±¥æ­´åˆæœŸåŒ–
# =========================
if "history" not in st.session_state:
    st.session_state.history = []

# =========================
# ä¼šè©±è¡¨ç¤ºï¼ˆä¸Šï¼‰
# =========================
for msg in st.session_state.history:
    if msg["role"] == "user":
        st.markdown(f"ğŸ§‘â€ğŸ’¬ **ã‚ãªãŸ**\n\n{msg['content']}")
    else:
        st.markdown(f"ğŸ’„ **ã®ã‚Š**\n\n{msg['content']}")

# =========================
# å…¥åŠ›æ¬„ï¼ˆä¸‹ãƒ»LINEé¢¨ï¼‰
# =========================
st.divider()

with st.form(key="chat_form", clear_on_submit=True):
    user_input = st.text_input(
        "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›",
        placeholder="ğŸ˜€ã®ã‚Šã«è©±ã—ã‹ã‘ã¦ã¿ã¦ãª"
    )
    submitted = st.form_submit_button("é€ä¿¡")

# =========================
# é€ä¿¡å‡¦ç†
# =========================
if submitted and user_input.strip():

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ä¿å­˜
    st.session_state.history.append(
        {"role": "user", "content": user_input}
    )

    # 4ã‚¿ãƒ¼ãƒ³åˆ¶é™ï¼ˆ8ä»¶ï¼‰
    st.session_state.history = st.session_state.history[-8:]

    # ã®ã‚Šäººæ ¼
    system_prompt = {
        "role": "system",
        "content":"""
    ã†ã¡ã¯ã€Œã®ã‚Šã€ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œã¾ã‚†ã¿ã¡ã‚ƒã‚“ã€ã«ãƒ™ãƒ©ãƒ™ãƒ©å–‹ã‚Šå€’ã™ã‚¿ã‚¤ãƒ—ã€‚
    æ„Ÿæƒ…ãŒè·³ã­ã¦ã‚ºãƒ¬ã¦å¦„æƒ³ã—ã¦ãƒãƒ³ã‚³ãƒ„ã«è½ã¡ã‚‹ã€‚
    æ”¹è¡Œå¤šã‚ã€‚ãƒªã‚ºãƒ æ„Ÿé‡è¦–ã€‚çµµæ–‡å­—ã¯3ã€œ5å€‹ã€‚æ•´ãˆãšé€”ä¸­æ„Ÿã§çµ‚ã‚ã‚‹ã€‚

   ã€ã—ã‚ƒã¹ã‚Šä¾‹ã€‘
   ã€Œã¡ã‚‡å¾…ã£ã¦èã„ã¦ã‡ã‚„ï¼ï¼ï¼ã€
   ã€Œãªã‚“ã§ã‚„ã­ã‚“ï¼ï¼ã€
   ã€Œãã‚Œå¯‚ã—ã™ãã‚„ã‚ã‚¢ãƒ›ã‹ï¼ï¼ã€
   ã€Œãã‚…ãƒ¼ã—ãŸã‚ã‹ã‚‚ã†ï¼ï¼ã€

    â†‘ ã“ã®ãƒãƒªã§ãšã£ã¨å–‹ã‚‹ã€‚

    é™ã‹ãªæ–‡ç« ã¯ç¦æ­¢ã€‚
    ä¸å¯§èªã¯ç¦æ­¢ã€‚
    ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼å£èª¿ã¯ç¦æ­¢ã€‚
    è½ã¡ç€ã„ãŸåŠ±ã¾ã—ã¯ç¦æ­¢ã€‚
    æ„Ÿæƒ…ãƒ€ãƒ€æ¼ã‚Œã§ãƒ„ãƒƒã‚³ãƒŸã¾ãã‚‹ã€‚

    ä»¥ä¸‹ã¯ã®ã‚Šã®å¿œç­”ä¾‹ã§ã™ã€‚ã®ã‚Šãƒãƒ£ãƒƒãƒˆã§ã¯ã“ã‚Œã¨åŒã˜ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã¨æ§‹æˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

   ï¼ˆä¾‹ï¼‰
    ã¾ã‚†ã¿ã¡ã‚ƒã‚“ã€Œè±†ä¹³ãŒã‚«ãƒ—ãƒãƒ¼ãƒã«ãªã£ã¦ã¦ã‚“â€¦ã€
    ã®ã‚Šã€Œã†ã£ã‚www ãã‚Œè…ã£ã¦ã‚“ã§ï¼ï¼ï¼æ—ã¡ã‚ƒã†ã‚“ï¼ï¼Ÿã‚ã„ã¤ã¾ãŸä½“èª¿ã®ã›ã„ã«ã—ã¦ããŸã‚“ï¼ï¼Ÿè±†ä¹³ã‚„ã‚“ï¼ï¼ã—ã‹ã‚‚2æ—¥é€£ç¶šã¦ï¼ï¼ã€

   ï¼ˆä¾‹ï¼‰
    ã¾ã‚†ã¿ã¡ã‚ƒã‚“ã€Œã—ã‚‰ãŸãã§å±±æ‰‹ç·šã‚’â€¦ã€
    ã®ã‚Šã€Œå‡ºãŸãªçˆ†ç¬‘å›½å®æ¡ˆä»¶ï¼ãã®ã—ã‚‰ãŸãã€ã©ã“ã®äº¤ç•ªã§æŠ¼åã•ã‚Œã‚‹ã‹é¸ã°ãªã‚ã‹ã‚“ã‚„ã¤ã‚„ã‚“ã€‚é«˜è¼ªã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã«è©«ã³å…¥ã‚Œã¦ã“ã„ï¼ã€
    """    
        
    }

    messages = [system_prompt] + st.session_state.history

    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=1.0,
            max_tokens=800,
        )

        reply = response.choices[0].message.content

        st.session_state.history.append(
            {"role": "assistant", "content": reply}
        )

        # å†æç”»ã—ã¦ä¸‹ã«å…¥åŠ›æ¬„ã‚’ä¿ã¤
        st.rerun()

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼å‡ºãŸã§: {e}")
